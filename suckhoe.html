<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiếu AI - Healthy | Trợ lý AI kiểm tra sức khỏe</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #6a5acd; /* Purple */
            --secondary-color: #00bfff; /* Deep Sky Blue */
            --accent-color: #ff69b4; /* Hot Pink */
            --background-color: #0a0a1a; /* Dark blue-black */
            --card-color: rgba(16, 16, 36, 0.8); /* Semi-transparent dark */
            --text-color: #e0e0ff; /* Light blue-white */
            --text-secondary: #a0a0c0; /* Lighter text */
            --border-radius: 16px;
            --box-shadow: 0 4px 24px rgba(106, 90, 205, 0.2);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --space-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
            background: var(--space-gradient);
        }

        /* Space background elements */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle var(--duration, 5s) infinite ease-in-out;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }

        .shooting-star {
            position: absolute;
            width: 4px;
            height: 4px;
            background: linear-gradient(to right, rgba(255,255,255,0), #fff);
            border-radius: 50%;
            filter: drop-shadow(0 0 6px var(--secondary-color));
            animation: shoot var(--shoot-duration, 3s) linear infinite;
            opacity: 0;
        }

        @keyframes shoot {
            0% {
                transform: translateX(0) translateY(0);
                opacity: 1;
            }
            70% {
                opacity: 1;
            }
            100% {
                transform: translateX(1000px) translateY(300px);
                opacity: 0;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 1px solid rgba(106, 90, 205, 0.3);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 15px var(--primary-color);
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--secondary-color);
            text-shadow: 0 0 10px rgba(0, 191, 255, 0.5);
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .form-section, .chat-section {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(106, 90, 205, 0.3);
        }

        .chat-section {
            display: none;
            height: 600px;
            position: relative;
            overflow: hidden;
        }

        h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--secondary-color);
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(106, 90, 205, 0.5);
            border-radius: var(--border-radius);
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            transition: var(--transition);
            background-color: rgba(10, 10, 30, 0.5);
            color: var(--text-color);
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(106, 90, 205, 0.4);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 0 15px rgba(106, 90, 205, 0.5);
        }

        .btn:hover {
            background-color: #5a4acd;
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(106, 90, 205, 0.8);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.5);
        }

        .btn-secondary:hover {
            background-color: #00a5e0;
            box-shadow: 0 0 20px rgba(0, 191, 255, 0.8);
        }

        .btn-danger {
            background-color: var(--accent-color);
            box-shadow: 0 0 15px rgba(255, 105, 180, 0.5);
        }

        .btn-danger:hover {
            background-color: #e55fa0;
            box-shadow: 0 0 20px rgba(255, 105, 180, 0.8);
        }

        .chat-container {
            height: calc(100% - 60px);
            overflow-y: auto;
            padding: 20px;
            border-radius: var(--border-radius);
            background-color: rgba(10, 10, 30, 0.3);
            margin-bottom: 20px;
            border: 1px solid rgba(106, 90, 205, 0.2);
        }

        .message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: var(--border-radius);
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
            transition: var(--transition);
        }

        .user-message {
            background-color: rgba(106, 90, 205, 0.3);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
            border: 1px solid var(--primary-color);
            box-shadow: 0 0 10px rgba(106, 90, 205, 0.2);
        }

        .ai-message {
            background-color: rgba(16, 16, 36, 0.8);
            color: var(--text-color);
            margin-right: auto;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 191, 255, 0.3);
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            position: absolute;
            bottom: 30px;
            left: 30px;
            right: 30px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid rgba(106, 90, 205, 0.5);
            border-radius: var(--border-radius);
            font-size: 16px;
            background-color: rgba(10, 10, 30, 0.7);
            color: var(--text-color);
            box-shadow: 0 0 10px rgba(106, 90, 205, 0.1);
        }

        .send-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 0 15px rgba(106, 90, 205, 0.5);
        }

        .send-btn:hover {
            background-color: #5a4acd;
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(106, 90, 205, 0.8);
        }

        .loading-animation {
            display: flex;
            gap: 8px;
            padding: 16px;
            justify-content: center;
        }

        .dot {
            width: 10px;
            height: 10px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
            box-shadow: 0 0 10px var(--secondary-color);
        }

        .dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% { 
                transform: scale(0);
            } 40% { 
                transform: scale(1);
            }
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .reset-btn {
            background-color: transparent;
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            padding: 8px 16px;
            border-radius: var(--border-radius);
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
        }

        .reset-btn:hover {
            background-color: rgba(255, 105, 180, 0.1);
            box-shadow: 0 0 15px rgba(255, 105, 180, 0.3);
        }

        .diagnosis-animation {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            margin: 20px 0;
        }

        .pulse {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            animation: pulse 2s infinite;
            margin-bottom: 20px;
            box-shadow: 0 0 20px var(--primary-color);
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(106, 90, 205, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 15px rgba(106, 90, 205, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(106, 90, 205, 0);
            }
        }

        .status-text {
            font-size: 18px;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Markdown styles */
        .markdown-content {
            line-height: 1.8;
        }

        .markdown-content strong {
            font-weight: 600;
            color: var(--secondary-color);
        }

        .markdown-content em {
            font-style: italic;
        }

        .markdown-content ul, .markdown-content ol {
            margin-left: 20px;
            margin-bottom: 16px;
        }

        .markdown-content li {
            margin-bottom: 8px;
        }

        .markdown-content a {
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .markdown-content a:hover {
            text-decoration: underline;
            color: var(--primary-color);
        }

        .markdown-content blockquote {
            border-left: 4px solid var(--primary-color);
            padding-left: 16px;
            margin: 16px 0;
            color: var(--text-secondary);
            background-color: rgba(106, 90, 205, 0.1);
            border-radius: 0 8px 8px 0;
        }

        .markdown-content hr {
            border: none;
            border-top: 1px solid rgba(106, 90, 205, 0.3);
            margin: 24px 0;
        }

        /* Floating planet decoration */
        .planet {
            position: absolute;
            border-radius: 50%;
            filter: blur(1px);
            opacity: 0.7;
            z-index: -1;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .form-section, .chat-section {
                padding: 20px;
            }

            .chat-section {
                height: 500px;
            }

            .chat-input-container {
                left: 20px;
                right: 20px;
                bottom: 20px;
            }

            .message {
                max-width: 90%;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 20px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 14px;
            }

            .chat-input {
                padding: 10px 14px;
                font-size: 14px;
            }

            .send-btn {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Space background elements -->
    <div class="stars" id="stars"></div>
    <div class="shooting-stars" id="shootingStars"></div>
    
    <div class="container">
        <header>
            <div class="logo-container">
                <h1>Hiếu AI - Healthy</h1>
            </div>
            <div class="header-actions">
                <button id="resetAllBtn" class="reset-btn">
                    <i class="fas fa-redo"></i> Đặt lại
                </button>
            </div>
        </header>

        <main class="main-content">
            <section class="form-section" id="formSection">
                <h2><i class="fas fa-user-astronaut"></i> Thông tin sức khỏe của bạn</h2>
                <form id="healthForm">
                    <div class="form-group">
                        <label for="name"><i class="fas fa-id-card"></i> Họ và tên</label>
                        <input type="text" id="name" name="name" placeholder="Nhập họ và tên của bạn" required>
                    </div>

                    <div class="form-group">
                        <label for="age"><i class="fas fa-birthday-cake"></i> Tuổi</label>
                        <input type="number" id="age" name="age" placeholder="Nhập tuổi của bạn" required min="1" max="120">
                    </div>

                    <div class="form-group">
                        <label for="gender"><i class="fas fa-venus-mars"></i> Giới tính</label>
                        <select id="gender" name="gender" required>
                            <option value="">Chọn giới tính</option>
                            <option value="Nam">Nam</option>
                            <option value="Nữ">Nữ</option>
                            <option value="Khác">Khác</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="symptoms"><i class="fas fa-thermometer-half"></i> Triệu chứng</label>
                        <textarea id="symptoms" name="symptoms" placeholder="Mô tả chi tiết các triệu chứng bạn đang gặp phải (vị trí, mức độ, thời gian xuất hiện,...)" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="condition"><i class="fas fa-heartbeat"></i> Tình trạng sức khỏe hiện tại</label>
                        <textarea id="condition" name="condition" placeholder="Mô tả tình trạng sức khỏe tổng thể của bạn (tiền sử bệnh, thuốc đang dùng,...)"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="lifestyle"><i class="fas fa-running"></i> Lối sống và thói quen</label>
                        <textarea id="lifestyle" name="lifestyle" placeholder="Mô tả lối sống và thói quen của bạn (chế độ ăn, tập luyện, hút thuốc, uống rượu,...)"></textarea>
                    </div>

                    <button type="submit" class="btn" id="submitBtn">
                        <i class="fas fa-stethoscope"></i> Kiểm tra với AI
                    </button>
                </form>
            </section>

            <section class="chat-section" id="chatSection">
                <div class="chat-header">
                    <h2><i class="fas fa-robot"></i> Hiếu AI - Trợ lý sức khỏe của bạn</h2>
                    <button id="resetChatBtn" class="reset-btn">
                        <i class="fas fa-trash-alt"></i> Xóa lịch sử
                    </button>
                </div>

                <div class="chat-container" id="chatContainer">
                    <!-- Chat messages will be inserted here -->
                </div>

                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="userInput" placeholder="Nhập câu hỏi hoặc thông tin thêm về sức khỏe của bạn...">
                    <button class="send-btn" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Create stars and shooting stars
            createStars();
            createShootingStars();

            // DOM Elements
            const healthForm = document.getElementById('healthForm');
            const formSection = document.getElementById('formSection');
            const chatSection = document.getElementById('chatSection');
            const chatContainer = document.getElementById('chatContainer');
            const userInput = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendBtn');
            const submitBtn = document.getElementById('submitBtn');
            const resetChatBtn = document.getElementById('resetChatBtn');
            const resetAllBtn = document.getElementById('resetAllBtn');

            // API Configuration
            const API_KEY = 'AIzaSyCOFBRKmDGipgq3cX2aI_74NfSfjZ_bYtE';
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

            // Conversation history
            let conversationHistory = JSON.parse(localStorage.getItem('khoaAI_conversation')) || [];

            // Initialize the chat if history exists
            if (conversationHistory.length > 0) {
                showChatSection();
                conversationHistory.forEach(msg => {
                    appendMessage(msg.role, msg.content);
                });
            }

            // Form submission
            healthForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang phân tích...';
                
                const formData = new FormData(healthForm);
                const healthInfo = {
                    name: formData.get('name'),
                    age: formData.get('age'),
                    gender: formData.get('gender'),
                    symptoms: formData.get('symptoms'),
                    condition: formData.get('condition'),
                    lifestyle: formData.get('lifestyle')
                };

                // Save health info to localStorage
                localStorage.setItem('khoaAI_healthInfo', JSON.stringify(healthInfo));
                
                // Show chat section
                showChatSection();
                
                // Show diagnosis animation
                showDiagnosisAnimation();
                
                // Generate initial AI response
                try {
                    const aiResponse = await generateAIResponse(healthInfo, null, true);
                    appendMessage('model', aiResponse);
                    conversationHistory.push({ role: 'model', content: aiResponse });
                    saveConversation();
                } catch (error) {
                    console.error('Error:', error);
                    appendMessage('model', 'Xin lỗi, đã có lỗi xảy ra khi kết nối với AI. Vui lòng thử lại sau.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-stethoscope"></i> Kiểm tra với AI';
                }
            });

            // Send message
            sendBtn.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Reset buttons
            resetChatBtn.addEventListener('click', resetConversation);
            resetAllBtn.addEventListener('click', resetAll);

            // Functions
            function createStars() {
                const starsContainer = document.getElementById('stars');
                const starCount = 200;
                
                for (let i = 0; i < starCount; i++) {
                    const star = document.createElement('div');
                    star.classList.add('star');
                    
                    // Random position
                    const x = Math.random() * 100;
                    const y = Math.random() * 100;
                    
                    // Random size
                    const size = Math.random() * 3;
                    
                    // Random animation duration
                    const duration = 5 + Math.random() * 10;
                    
                    star.style.left = `${x}%`;
                    star.style.top = `${y}%`;
                    star.style.width = `${size}px`;
                    star.style.height = `${size}px`;
                    star.style.setProperty('--duration', `${duration}s`);
                    
                    starsContainer.appendChild(star);
                }
            }

            function createShootingStars() {
                const shootingStarsContainer = document.getElementById('shootingStars');
                const shootingStarCount = 5;
                
                for (let i = 0; i < shootingStarCount; i++) {
                    const shootingStar = document.createElement('div');
                    shootingStar.classList.add('shooting-star');
                    
                    // Random position
                    const x = Math.random() * 20;
                    const y = Math.random() * 20;
                    
                    // Random animation duration and delay
                    const duration = 2 + Math.random() * 3;
                    const delay = Math.random() * 10;
                    
                    shootingStar.style.left = `${x}%`;
                    shootingStar.style.top = `${y}%`;
                    shootingStar.style.setProperty('--shoot-duration', `${duration}s`);
                    shootingStar.style.animationDelay = `${delay}s`;
                    
                    shootingStarsContainer.appendChild(shootingStar);
                }
            }

            function showChatSection() {
                formSection.style.display = 'none';
                chatSection.style.display = 'block';
                
                
            }

            function showFormSection() {
                chatSection.style.display = 'none';
                formSection.style.display = 'block';
            }

            function showDiagnosisAnimation() {
                chatContainer.innerHTML = `
                    <div class="diagnosis-animation">
                        <div class="pulse">
                            <i class="fas fa-heartbeat"></i>
                        </div>
                        <p class="status-text">Hiếu AI đang phân tích triệu chứng của bạn...</p>
                    </div>
                `;
            }

            function appendMessage(role, content) {
                // Remove animation if present
                const animation = document.querySelector('.diagnosis-animation');
                if (animation) {
                    animation.remove();
                }

                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message');
                
                if (role === 'user') {
                    messageDiv.classList.add('user-message');
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <div class="message-sender"><i class="fas fa-user"></i> Bạn</div>
                            <div class="message-text">${content}</div>
                        </div>
                    `;
                } else {
                    messageDiv.classList.add('ai-message');
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <div class="message-sender"><i class="fas fa-robot"></i> Hiếu AI</div>
                            <div class="markdown-content">${formatMarkdown(content)}</div>
                        </div>
                    `;
                }
                
                chatContainer.appendChild(messageDiv);
               
            }

            function formatMarkdown(text) {
                // Convert markdown to HTML
                let html = text;
                
                // Headers
                html = html.replace(/^# (.*$)/gm, '<h3>$1</h3>');
                html = html.replace(/^## (.*$)/gm, '<h4>$1</h4>');
                html = html.replace(/^### (.*$)/gm, '<h5>$1</h5>');
                
                // Bold and italic
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
                html = html.replace(/\_(.*?)\_/g, '<em>$1</em>');
                
                // Links
                html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
                
                // Lists
                html = html.replace(/^\s*\*\s(.*$)/gm, '<li>$1</li>');
                html = html.replace(/^\s*-\s(.*$)/gm, '<li>$1</li>');
                html = html.replace(/^\s*\+\s(.*$)/gm, '<li>$1</li>');
                html = html.replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>');
                
                // Line breaks
                html = html.replace(/\n/g, '<br>');
                
                // Blockquotes
                html = html.replace(/^>\s(.*$)/gm, '<blockquote>$1</blockquote>');
                
                return html;
            }

            async function sendMessage() {
                const message = userInput.value.trim();
                if (!message) return;

                // Add user message to chat
                appendMessage('user', message);
                conversationHistory.push({ role: 'user', content: message });
                saveConversation();
                
                // Clear input
                userInput.value = '';
                
                // Show loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.classList.add('loading-animation');
                loadingDiv.innerHTML = `
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                `;
                chatContainer.appendChild(loadingDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                try {
                    // Get health info from localStorage
                    const healthInfo = JSON.parse(localStorage.getItem('khoaAI_healthInfo')) || {};
                    
                    // Generate AI response
                    const aiResponse = await generateAIResponse(healthInfo, message, false);
                    appendMessage('model', aiResponse);
                    conversationHistory.push({ role: 'model', content: aiResponse });
                    saveConversation();
                } catch (error) {
                    console.error('Error:', error);
                    appendMessage('model', 'Xin lỗi, đã có lỗi xảy ra khi kết nối với AI. Vui lòng thử lại sau.');
                } finally {
                    // Remove loading indicator
                    loadingDiv.remove();
                }
            }

            async function generateAIResponse(healthInfo, userMessage, isInitial) {
                let prompt = '';
                
                if (isInitial) {
                    prompt = `Bạn là "Hiếu AI", một trợ lý AI chuyên về sức khỏe và y tế. Bạn đang trò chuyện với ${healthInfo.name}, ${healthInfo.age} tuổi, giới tính ${healthInfo.gender}. 
                    
Dựa trên các thông tin sau:
- Triệu chứng: ${healthInfo.symptoms}
- Tình trạng sức khỏe: ${healthInfo.condition || 'Không có thông tin'}
- Lối sống: ${healthInfo.lifestyle || 'Không có thông tin'}

Hãy phân tích các triệu chứng và đưa ra:
1. **Đánh giá sơ bộ** về tình trạng sức khỏe (in đậm các điểm quan trọng)
2. **Nguyên nhân có thể** (liệt kê dạng bullet points)
3. **Lời khuyên** về:
   - Chế độ ăn uống phù hợp
   - Thói quen sinh hoạt
4. **Khuyến nghị** có nên đi khám bác sĩ không và nếu có thì chuyên khoa nào phù hợp
5. Các **nguồn tham khảo** đáng tin cậy, uy tín về sức khỏe hoặc tâm lý tùy theo bệnh nhân (dạng link)

Trình bày rõ ràng, dễ hiểu, sử dụng markdown để định dạng (in đậm, in nghiêng, bullet points,...) và luôn thể hiện sự đồng cảm, quan tâm.`;
                } else {
                    // Build context from conversation history
                    let context = '';
                    conversationHistory.forEach(msg => {
                        context += `${msg.role === 'user' ? 'Bệnh nhân' : 'Bác sĩ AI'}: ${msg.content}\n`;
                    });
                    
                    prompt = `Tiếp tục cuộc trò chuyện với bệnh nhân dựa trên ngữ cảnh sau:\n\n${context}\n\nHãy trả lời câu hỏi/ý kiến sau của bệnh nhân một cách chuyên môn, nhiệt tình và dễ hiểu: "${userMessage}". 

Trình bày rõ ràng, sử dụng markdown để định dạng (in đậm, in nghiêng, bullet points khi cần) và cung cấp thông tin chính xác, hữu ích. Nếu cần thêm thông tin để chẩn đoán chính xác hơn, hãy yêu cầu bệnh nhân cung cấp thêm chi tiết.`;
                }
                
                const requestBody = {
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 2048
                    }
                };
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            }

            function saveConversation() {
                localStorage.setItem('khoaAI_conversation', JSON.stringify(conversationHistory));
            }

            function resetConversation() {
                if (confirm('Bạn có chắc muốn xóa toàn bộ lịch sử trò chuyện?')) {
                    conversationHistory = [];
                    localStorage.removeItem('khoaAI_conversation');
                    chatContainer.innerHTML = '';
                    
                    // Show initial message if health info exists
                    const healthInfo = JSON.parse(localStorage.getItem('khoaAI_healthInfo'));
                    if (healthInfo) {
                        appendMessage('model', `Xin chào lại ${healthInfo.name}! Tôi là Hiếu AI, trợ lý sức khỏe của bạn. Bạn có câu hỏi nào về sức khỏe không?`);
                        conversationHistory.push({ 
                            role: 'model', 
                            content: `Xin chào lại ${healthInfo.name}! Tôi là Hiếu AI, trợ lý sức khỏe của bạn. Bạn có câu hỏi nào về sức khỏe không?`
                        });
                        saveConversation();
                    }
                }
            }

            function resetAll() {
                if (confirm('Bạn có chắc muốn đặt lại toàn bộ thông tin và bắt đầu lại từ đầu?')) {
                    localStorage.removeItem('khoaAI_healthInfo');
                    localStorage.removeItem('khoaAI_conversation');
                    conversationHistory = [];
                    healthForm.reset();
                    showFormSection();
                }
            }
        });
    </script>
</body>
</html>